require 'test_helper'

class People::TeachersControllerTest < ActionController::TestCase
  
  def setup
    @request.session[:school] = @request.session[:user] = :exists
    @controller.stubs(:set_user).returns(@user = Teacher.new)
    @user.stubs(:school).returns(@school = School.new)
    @user.stubs(:admin?).returns(true)
    @school.stubs(:teachers).returns(@teachers = [Teacher.new, Teacher.new])
    Teacher.any_instance.stubs(:to_param).returns 'teacher'
  end

  def test_term_link_to_future
    stub_teachers
    @school.stubs(:terms).returns([Term.new(:low_period => 1, :high_period => 6), Term.new])
    @school.stubs(:teacher_limit).returns(1)
    Section.stubs(:find).returns([])
    get :index
    assert_response :success
    assert_select 'a[href=?]', teachers_url(:term => 'future'), :text => 'next'
  end

  def test_term_link_to_current
    stub_teachers
    @school.stubs(:terms).returns([Term.new, Term.new(:low_period => 1, :high_period => 6)])
    @school.stubs(:teacher_limit).returns(1)
    get :index, :term => 'future'
    assert_select 'a[href=?]', teachers_url, :text => 'current'
  end
    
  def test_show
    stub_teacher
    @teacher.stub_path('sections.where.includes').returns [@section = Section.new]
    @section.stubs(:to_param).returns 'section'
    Assignment.any_instance.stubs(:to_param).returns 'assignment'
    prep_mp
    get :show
    assert_response :success
  end

  def test_show_no_sections
    stub_teacher
    prep_mp
    get :show
    assert_response :success
  end

  def test_update
    stub_update
    put :update
    assert_redirected_to teacher_path(@teacher)
  end

  def test_update_and_reset
    stub_update
    put :update, :teacher => {:reauthorize => true}
    assert_redirected_to teacher_path(@teacher)
  end

  def test_update_fail
    stub_update(false)
    put :update
    assert_template('edit')
  end

  def test_logins
    stub_teacher
    @teacher.stubs(:id).returns(1)
    get :logins
    assert_response :success
  end

  def test_new
    get :new
    assert_response :success
  end

  def test_create
    @teachers.expects(:create).returns(@teacher = stub(:valid? => true, :full_name => 'name', :login => 'login'))
    post :create, :teacher => {:authorization => {:login => 'login'}}
    assert_redirected_to edit_teaching_load_path(@teacher)
  end

  def test_create_fail
    @teachers.expects(:create).returns(@teacher = Teacher.new)
    post :create
    assert_template('new')
  end

  def test_cannot_destroy_self
    stub_teacher
    @user.stubs(:id).returns('same')
    @teacher.stubs(:id).returns('same')
    delete :destroy
    assert_redirected_to teacher_path(@teacher)
  end

  def test_destroy
    stub_teacher
    @user.stubs(:id).returns('not the same as teacher')
    @teacher.expects(:destroy).returns(true)
    delete :destroy
    assert_redirected_to teachers_path
  end

  def test_destroy_xhr
    stub_teacher
    @user.stubs(:id).returns('not the same as teacher')
    @teacher.expects(:destroy).returns(true)
    xhr :delete, :destroy
    #assert_redirected_to teachers_path should be a way to do this...
  end
  
  def test_destroy_fail
    stub_teacher
    @user.stubs(:id).returns('not the same as teacher')
    @teacher.expects(:destroy).returns(false)
    delete :destroy
    assert_redirected_to teacher_path(@teacher)
  end
  protected
  
  def stub_find
    @teachers.expects(:find).returns([@teacher = Teacher.new(:last_name => 'test')])
  end
  
  def stub_teacher
    @teachers.expects(:find).returns(@teacher = Teacher.new(:first_name => 'test', :last_name => 'name'))
  end

  def stub_teachers
    Teacher.any_instance.stubs(:display_name).returns 'name'
  end

  def stub_update(response = true)
    stub_teacher
    @teacher.expects(:update_attributes).returns(response)
    @teacher.expects(:display_name).returns('teacher') if response
  end

end
